---
title: "02_vis_5fold"
output: html_document
---

```{r setup, include=FALSE, message=F, warning=F, echo=F}
knitr::opts_chunk$set(include=T, message=F, warning=F, echo=F, eval=T)
library(lubridate)
library(data.table)
library(wesanderson)
library(zoo)
```

## 

```{r load packages and read data}
source("../EXPANSE_algorithm/scr/fun_call_lib.R")
library(reshape2)
library(gtools)
library(GGally)
library(APMtools)
library(hydroGOF)

eu_bnd <- st_read("../expanse_shp/eu_expanse2.shp")
met_str <- 'precip|temp|wind|pressure'
years <- 2000:2019
nfold=5
```

```{r usefule functions}
source('src/fun_vis_5fold.R')
```

```{r}

```


```{r}
em_df <- lapply(c('NO2','O3','PM10','PM2.5'), overall_perfm) %>% do.call(rbind,.)
em_df_allClimates <- lapply(c('NO2','O3','PM10','PM2.5'), overall_perfm_allClimates) %>% do.call(rbind,.)
em_temp_df <- lapply(c('NO2','O3','PM10','PM2.5'), temp_perfm) %>% do.call(rbind,.)
em_temp_region_df <- lapply(c('NO2','O3','PM10','PM2.5'), temp_region_perfm) %>% do.call(rbind,.)
```


The long-term monthly model performance (the out-fold validation data in the same month and region):

```{r}

ggplot(em_temp_region_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'month', 'poll', 'climate_zone')) %>% filter(model=='gwr'), 
          aes(x=factor(month), y=values,  group=poll))+ ##col=model,
      geom_line()+
      geom_point()+
      labs(y="R squared", x='month')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      facet_grid(climate_zone~poll, scales ='fixed')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=0)
            )
ggsave('results/figures/monthly_long_perfm_region.png', height=6, width=7.5, units='in',dpi=300)

```
```{r}
em_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'month', 'poll', 'climate_zone','year','month'))
```
```{r}

em_df %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, climate_zone, date, poll, gwr) %>% summary

# em_df2 %>% filter(EM=='rsq', poll=='PM10', year==2000)
```

The model performance for all years with monthly variations indicated in a boxplot with regions
```{r}
names(em_df)
em_df2 <- em_df
em_df2$gwr[em_df2$gwr<0] <- 0
em_df2 %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, climate_zone, date, poll, gwr) %>% filter(poll=='PM2.5') %>% mutate(year=as.factor(year)) %>% summary
ggplot(em_df2 %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, climate_zone, date, poll, gwr) %>% mutate(year=as.factor(year)))+ ##col=model,
      geom_boxplot(aes(x=factor(year), y=gwr,  group=year))+
      labs(y="R squared", x='year')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(climate_zone~poll, scales ='fixed')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/yearly_boxplot_long_perfm_region.png', height=6, width=10, units='in',dpi=300)
```


heatmap: 

```{r}
library(wesanderson)
em_temp_df2 <- em_df_allClimates
em_temp_df2$gwr[em_temp_df2$gwr<0] <- 0
pal <- wes_palette("Zissou1", 100, type = "continuous")
ggplot(em_temp_df2 %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 2)), aes(y=as.factor(month), x=as.factor(year), group=poll))+
   geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1)+  #reorder(variables, class) 
   scale_fill_stepsn(colors=pal, 
                     n.breaks=12, limits=c(0,1), show.limits=T,
                     labels = scales::number_format(accuracy = 0.1,
                                                    decimal.mark = '.'),
                     na.value="black")+
   facet_wrap(poll~., scales = 'free_x')+
   geom_text(aes(label = gwr))+
   scale_y_discrete(limits=rev)+ ## reverse discontinuous values
   # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
   labs(y='month', x='year', fill='')+
   # scale_x_discrete(position = "top") +
   theme_minimal()+
   theme(axis.title = element_text(size = 13),
         axis.text = element_text(size = 11),
         axis.text.x = element_text(angle=90),
         legend.title = element_text(size = 13),
         legend.text = element_text(size = 13),
         legend.spacing.y = unit(0.01, 'cm'),
         strip.text = element_text(size = 12))+
   # theme(,
   #       )
   theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent'),
         panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black'))
ggsave('results/figures/heatmap_perfmR2.png', height=9, width=16, units='in',dpi=300)
```

```{r}
lapply(unique(em_temp_df2$poll), function(target_poll){
   plot_dfHeatmap <- em_temp_df2 %>% filter(EM=='rsq', poll==target_poll) %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 2))
   ggplot(plot_dfHeatmap, aes(y=as.factor(month), x=as.factor(year), group=poll))+
      geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1, alpha=0.7)+  #reorder(variables, class) 
      scale_fill_gradient(low = "white", high = "red")+ 
      facet_wrap(poll~., scales = 'free_x')+
      geom_text(aes(label = gwr))+
      scale_y_discrete(limits=rev)+ ## reverse discontinuous values
      # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
      labs(y='month', x='year', fill='')+
      # scale_x_discrete(position = "top") +
      theme_minimal()+
      theme(axis.title = element_text(size = 13),
            axis.text = element_text(size = 11),
            axis.line = element_blank(),
            panel.grid = element_blank(),
            strip.background = element_blank(),
            axis.text.x = element_text(angle=90),
            legend.title = element_text(size = 13),
            legend.text = element_text(size = 13),
            legend.spacing.y = unit(0.01, 'cm'),
            strip.text = element_text(size = 12))+
      # theme(,
      #       )
      theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent')
            # panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black')
            )
   ggsave(paste0('results/figures/heatmap_perfmR2_', target_poll, '_v2.png'), height=5, width=10, units='in',dpi=300)
})

lapply(unique(em_temp_df2$poll), function(target_poll){
   plot_dfHeatmap <- em_temp_df2 %>% filter(EM=='RMSE', poll==target_poll) %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 2))
   ggplot(plot_dfHeatmap, aes(y=as.factor(month), x=as.factor(year), group=poll))+
      geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1, alpha=0.7)+  #reorder(variables, class) 
      scale_fill_gradient(low = "white", high = "red")+ 
      facet_wrap(poll~., scales = 'free_x')+
      geom_text(aes(label = gwr))+
      scale_y_discrete(limits=rev)+ ## reverse discontinuous values
      # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
      labs(y='month', x='year', fill='')+
      # scale_x_discrete(position = "top") +
      theme_minimal()+
      theme(axis.title = element_text(size = 13),
            axis.text = element_text(size = 11),
            axis.line = element_blank(),
            panel.grid = element_blank(),
            strip.background = element_blank(),
            axis.text.x = element_text(angle=90),
            legend.title = element_text(size = 13),
            legend.text = element_text(size = 13),
            legend.spacing.y = unit(0.01, 'cm'),
            strip.text = element_text(size = 12))+
      # theme(,
      #       )
      theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent')
            # panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black')
            )
   ggsave(paste0('results/figures/heatmap_perfmRMSE_', target_poll, '_v2.png'), height=5, width=10, units='in',dpi=300)
})

lapply(unique(em_temp_df2$poll), function(target_poll){
   plot_dfHeatmap <- em_temp_df2 %>% filter(EM=='RRMSE', poll==target_poll) %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 2))
   ggplot(plot_dfHeatmap, aes(y=as.factor(month), x=as.factor(year), group=poll))+
      geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1, alpha=0.7)+  #reorder(variables, class) 
      scale_fill_gradient(low = "white", high = "red")+ 
      facet_wrap(poll~., scales = 'free_x')+
      geom_text(aes(label = gwr))+
      scale_y_discrete(limits=rev)+ ## reverse discontinuous values
      # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
      labs(y='month', x='year', fill='')+
      # scale_x_discrete(position = "top") +
      theme_minimal()+
      theme(axis.title = element_text(size = 13),
            axis.text = element_text(size = 11),
            axis.line = element_blank(),
            panel.grid = element_blank(),
            strip.background = element_blank(),
            axis.text.x = element_text(angle=90),
            legend.title = element_text(size = 13),
            legend.text = element_text(size = 13),
            legend.spacing.y = unit(0.01, 'cm'),
            strip.text = element_text(size = 12))+
      # theme(,
      #       )
      theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent')
            # panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black')
            )
   ggsave(paste0('results/figures/heatmap_perfmNormalizedRMSE_', target_poll, '_v2.png'), height=5, width=10, units='in',dpi=300)
})
```


```{r}
ggplot(em_temp_df2 %>% filter(EM=='RMSE') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 1)), aes(y=as.factor(month), x=as.factor(year), group=poll))+
   geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1)+  #reorder(variables, class) 
   scale_fill_stepsn(colors=rev(pal), 
                     n.breaks=12, limits=c(0,20), show.limits=T,
                     labels = scales::number_format(accuracy = 0.1,
                                                    decimal.mark = '.'),
                     na.value="black")+
   facet_wrap(poll~., scales = 'free_x')+
   geom_text(aes(label = gwr))+
   scale_y_discrete(limits=rev)+ ## reverse discontinuous values
   # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
   labs(y='month', x='year', fill='')+
   # scale_x_discrete(position = "top") +
   theme_minimal()+
   theme(axis.title = element_text(size = 13),
         axis.text = element_text(size = 11),
         axis.text.x = element_text(angle=90),
         legend.title = element_text(size = 13),
         legend.text = element_text(size = 13),
         legend.spacing.y = unit(0.01, 'cm'),
         strip.text = element_text(size = 12))+
   # theme(,
   #       )
   theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent'),
         panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black'))
ggsave('results/figures/heatmap_perfmRMSE.png', height=9, width=18, units='in',dpi=300)
```
```{r}
ggplot(em_temp_df2 %>% filter(EM=='RRMSE') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year), gwr=round(gwr, 1)), aes(y=as.factor(month), x=as.factor(year), group=poll))+
   geom_tile(aes(fill=gwr), show.legend = F, color='black', lwd = 0.1, linetype = 1)+  #reorder(variables, class) 
   scale_fill_stepsn(colors=rev(pal), 
                     n.breaks=12, limits=c(0,20), show.limits=T,
                     labels = scales::number_format(accuracy = 0.1,
                                                    decimal.mark = '.'),
                     na.value="black")+
   facet_wrap(poll~., scales = 'free_x')+
   geom_text(aes(label = gwr))+
   scale_y_discrete(limits=rev)+ ## reverse discontinuous values
   # scale_fill_manual(values=c('The best'='red','.'='transparent'))+
   labs(y='month', x='year', fill='')+
   # scale_x_discrete(position = "top") +
   theme_minimal()+
   theme(axis.title = element_text(size = 13),
         axis.text = element_text(size = 11),
         axis.text.x = element_text(angle=90),
         legend.title = element_text(size = 13),
         legend.text = element_text(size = 13),
         legend.spacing.y = unit(0.01, 'cm'),
         strip.text = element_text(size = 12))+
   # theme(,
   #       )
   theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent'),
         panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black'))
ggsave('results/figures/heatmap_perfmNormalizedRMSE.png', height=9, width=18, units='in',dpi=300)
```



```{r}
em_temp_df2 <- em_df_allClimates
em_temp_df2$gwr[em_temp_df2$gwr<0] <- 0
names(em_temp_df2)
ggplot(em_temp_df2 %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year)))+ ##col=model,
      geom_boxplot(aes(x=factor(year), y=gwr,  group=year))+
      labs(y="R squared", x='year')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/yearly_boxplot_long_perfm.png', height=3, width=8.5, units='in',dpi=300)
```

```{r}
ggplot(em_temp_df2 %>% filter(EM=='rsq') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(month=as.factor(month)))+ ##col=model,
      geom_boxplot(aes(x=factor(month), y=gwr,  group=month))+
      labs(y="R2", x='month')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50')
            # axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/monthlyly_boxplot_long_perfmR2.png', height=2.6, width=8.5, units='in',dpi=300)
```


```{r}
em_temp_df2 <- em_df_allClimates
em_temp_df2$gwr[em_temp_df2$gwr<0] <- 0
ggplot(em_temp_df2 %>% filter(EM=='RMSE') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(year=as.factor(year)))+ ##col=model,
      geom_boxplot(aes(x=factor(year), y=gwr,  group=year))+
      labs(y="RMSE", x='year')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/yearly_boxplot_long_perfmRMSE.png', height=3, width=8.5, units='in',dpi=300)
```

```{r}
ggplot(em_temp_df2 %>% filter(EM=='RMSE') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(month=as.factor(month)))+ ##col=model,
      geom_boxplot(aes(x=factor(month), y=gwr,  group=month))+
      labs(y="RMSE", x='month')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50')
            # axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/monthly_boxplot_long_perfmRMSE.png', height=2.6, width=8.5, units='in',dpi=300)
```
```{r}
ggplot(em_temp_df2 %>% filter(EM=='RRMSE') %>% dplyr::select(EM, year, month, date, poll, gwr) %>% mutate(month=as.factor(month)))+ ##col=model,
      geom_boxplot(aes(x=factor(month), y=gwr,  group=month))+
      labs(y="nRMSE", x='month')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      # facet_grid(climate_zone~., scales ='fixed')+  #model
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50')
            # axis.text.x = element_text(angle=90)
            )
ggsave('results/figures/monthly_boxplot_long_perfmnRMSE.png', height=2.6, width=8.5, units='in',dpi=300)
```




```{r}
target_poll <- 'PM2.5'
all_test_sep <- read_perfm(target_poll)
all_test_sep_df <- do.call(rbind, all_test_sep)
names(all_test_sep_df)
```

```{r}
ggplot(all_test_sep_df, aes(x=year))
```

The long-term monthly model performance (the out-fold validation data in the same month):

```{r}

ggplot(em_temp_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'month', 'poll')) %>% filter(model=='gwr'), 
          aes(x=factor(month), y=values,  group=poll))+ ##col=model,
      geom_line()+
      geom_point()+
      labs(y="R squared", x='month')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      facet_grid(.~poll, scales ='free')+  #model
      theme_bw()+
      # scale_x_date(date_breaks = "1 month",
      #              date_labels = "%m")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=0)
            )
ggsave('results/figures/monthly_long_perfm.png', height=3.3, width=6.4, units='in',dpi=300)
```

Why the R2 values are different in months?
For PM2.5 and PM10, it could be indeed because of the low spatial variations in the observations (narrow range of IQR, interquartile range: the range for the middle 50% of the data). But this is not necessarily the reason of the low R2 values in some specific months. And if we look at the boxplot of R2 values in each month and region (over time), you can see that it's not just some outliers making the overall R2 values to fluctuate. Instead the mean and median of the R2 values also fluctuate.. So the monthly-varying R2 values could also be because the predictors were not enough to capture the spatial variations in those months and regions.


The percentage of the monthly observations that only exist in the monthly model:
```{r}
apm_all_by_regionAndmonth <- lapply(c('NO2','O3','PM10','PM2.5'), read_dflist) %>% do.call(rbind,.)
apm_all_by_regionAndmonth <- do.call(rbind, apm_all_by_regionAndmonth)
table(apm_all_by_regionAndmonth$year, apm_all_by_regionAndmonth$month, apm_all_by_regionAndmonth$poll)
sta_monthlyonly <- apm_all_by_regionAndmonth %>% group_by(sta_code, year, poll) %>% count(sta_code) %>% filter(n<9) 
sta_annual <- apm_all_by_regionAndmonth %>% group_by(sta_code, year, poll) %>% count(sta_code) %>% filter(n>=9) 
# table(sta_monthlyonly$year, sta_monthlyonly$poll)
# table(sta_annual$year, sta_annual$poll)
table(sta_monthlyonly$year, sta_monthlyonly$poll)/(table(sta_annual$year, sta_annual$poll)+table(sta_monthlyonly$year, sta_monthlyonly$poll))*100

test_df <- apm_all_by_regionAndmonth %>% group_by(sta_code, year, poll, month) %>% count(sta_code) 
table(test_df$month, test_df$year, test_df$poll)
```


```{r}

apm_all_by_month <- lapply(c('NO2','O3','PM10','PM2.5'), read_dflist_new) %>% do.call(rbind,.)

test_df2 <- apm_all_by_month %>% group_by(sta_code, year, poll, month) %>% count(sta_code) 
table(test_df2$month, test_df2$year, test_df2$poll)
```
```{r}
table(apm_all_by_month$month, apm_all_by_month$year, apm_all_by_month$poll)
```

```{r}

df_allcodes2 <- read.csv('data/processed/climate_code.csv', header = T)

```

```{r}
ggplot(apm_all_by_regionAndmonth, aes(x=month, y=obs))+
   geom_boxplot(aes(group=month))+
   facet_grid(climate_zone~poll, scales = 'free_y')
```

```{r}
apm_all_by_iqr <- apm_all_by_regionAndmonth %>% 
   group_by(climate_zone, month, poll) %>% 
   summarise(iqr=IQR(obs))
   
ggplot(apm_all_by_iqr, aes(x=factor(month), y=iqr))+
   geom_point()+
   geom_line()+
   facet_grid(climate_zone~poll, scales = 'fixed')
```



```{r overall monthly performance (5-fold CV), eval=F, echo=F, fig.height=12, fig.width=8}
# Overall
# GWR predictions have missing values
# dat_test <- em_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll'))
# dat_test[(is.na(dat_test$values)),] %>% nrow
ggplot(em_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'monthNo', 'count', 'date', 'poll', 'climate_zone')) %>% filter(model=='gwr'), 
          aes(x=factor(month), y=values,  group=factor(month)))+
   geom_boxplot()+
      # geom_line()+
      # geom_point()+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      facet_grid(climate_zone~poll, scales ='fixed')+
      theme_bw()+
      # scale_x_date(date_breaks = "1 year",
      #              date_labels = "%Y",
      #              date_minor_breaks = "6 months")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=0)
            )
ggsave('results/figures/monthly_perfm_boxplot.png', height=7.5, width=10, units='in',dpi=100)
```


```{r, eval=F, echo=F, fig.height=12, fig.width=8}
# How count might influence such performance variation
ggplot(em_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'monthNo', 'count', 'date', 'poll', 'climate_zone')) %>% filter(model=='gwr'), 
          aes(x=factor(month), y=count,  group=factor(month)))+
   geom_boxplot()+
      # geom_line()+
      # geom_point()+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      facet_grid(climate_zone~poll, scales ='fixed')+
      theme_bw()+
      # scale_x_date(date_breaks = "1 year",
      #              date_labels = "%Y",
      #              date_minor_breaks = "6 months")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=0)
            )

## Is it better to combine data points in Northern and Alpine when calculateing the R2?
```

## Boxplot of the R2 values

```{r boxplot of the R2 values}
em_df%>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll'))

ggplot(em_df%>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll')) %>% filter(model=='gwr'))+
   geom_boxplot(aes(x=as.factor(month),y=values,group=month))+
   facet_grid(poll~.)+
   labs(x='month', y='R squared')+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text = element_text(size = 15))

ggsave('results/figures/boxplot_R2_monthly.tiff', height=6, width=6.5, units='in',dpi=300)

```

why the monthly R2 values are quite different between years? Well i think it's just merely because the scale of the observations changed and thus the R2 changed. When we used RRMSE as a performance evaluation matrix, the seasonal variations in the model performance were gone: 

```{r}
em_df%>% filter(EM=='RRMSE') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll'))

ggplot(em_df%>% filter(EM=='RRMSE') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll')) %>% filter(model=='gwr'))+
   geom_boxplot(aes(x=as.factor(month),y=values,group=month))+
   facet_grid(poll~.)+
   labs(x='month', y='RRMSE')+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text = element_text(size = 15))
```


## Boxplot of the observations
```{r}
all_test_sep <- lapply(c("NO2", "O3", "PM10", "PM2.5"),
                       function(target_poll){
                          all_test_sep <- read_perfm(target_poll)
                          all_test_sep <- do.call(rbind, all_test_sep)
                          all_test_sep %>% mutate(poll=target_poll)
                       })
all_test_sep <- do.call(rbind, all_test_sep)
ggplot(all_test_sep)+
   geom_boxplot(aes(x=as.factor(month), y=obs, group=month))+
      facet_grid(poll~.)+
   labs(x='month', y='R squared')+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text = element_text(size = 15))
ggsave('results/figures/boxplot_obs_monthly.tiff', height=6, width=6.5, units='in',dpi=300)
```



The number of observations is quite stable over a year:
```{r}
freq <- as.data.frame(table(all_test_sep$month, all_test_sep$poll, all_test_sep$year)) %>% 
   rename(month=Var1, poll=Var2, year=Var3, count=Freq)
ggplot(freq)+
   geom_line(aes(x=month, y=count, col=year,group=year))+
   facet_grid(poll~., scales = 'free_y')
   
```

```{r}
ggplot(all_test_sep)+
   geom_point(aes(x=gwr, y=obs))+
   facet_grid(poll~month)+
   lims(y=c(0,400), x=c(0,400))+
   geom_abline(slope = 1, intercept = 0)
ggsave('results/figures/scatterplot_monthly.tiff', height=6, width=15, units='in',dpi=100)

ggplot(all_test_sep)+
   geom_point(aes(x=gwr, y=obs))+
   facet_grid(poll~month, scales = 'free')+
   # lims(y=c(0,400), x=c(0,400))+
   geom_abline(slope = 1, intercept = 0)
ggsave('results/figures/scatterplot_monthly_free.tiff', height=6, width=15, units='in',dpi=100)
```


```{r overall monthly performance (5-fold CV) 2, eval=F, echo=F}
ggplot(em_df %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'year','month', 'count', 'date', 'poll')) %>% filter(year%in%(2008:2010)), 
          aes(x=date, y=values, col=poll))+
      geom_line()+
      geom_point()+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      facet_grid(model~., scales ='fixed')+
      theme_bw()+
      scale_x_date(date_breaks = "1 months",
                   date_labels = "%Y%m",
                   date_minor_breaks = "6 months")+
      theme(panel.grid.minor.x=element_line(colour='grey50'),
            axis.text.x = element_text(angle=90)
            )
```


```{r overall monthly performance (5-fold CV), eval=F, echo=F, fig.height=12, fig.width=8}
```

## 5-fold accuracy of annual aggregated predictions
```{r aggregated annual performance (5-fold CV)}
annual_perf <- function(target_poll){
   
   all_test_sep <- read_perfm(target_poll)
   all_test2 <- read_perfm2(target_poll)
   all_test2df <- do.call(rbind, all_test2)
   
   all_m_sepy <- lapply(all_test_sep, function(all_m_sep){  ## how many stations were having monthly obs but not annual obs (because of the 9months/75%validity criteria)?
      all_m_sep %>% 
         filter(sta_code%in%(names(table(all_m_sep$sta_code)[table(all_m_sep$sta_code)>=9]))) %>% 
         group_by(sta_code, year) %>% 
         summarise(rf=mean(rf), slr=mean(slr), gwr=mean(gwr), .groups = 'drop') %>% 
         inner_join(., (all_test2df %>% filter(year==unique(all_m_sep$year)))[, c('obs','sta_code')], by='sta_code')
   })
  
   # Monthly models (built for each month)
   em_df1_sep <-  lapply(seq_along(all_m_sepy), show_EM, all_test=all_m_sepy)
   em_df1_sep <- do.call(rbind, em_df1_sep)
   em_df1_sep$config <- '1-month'
   
   # Annual models (bult for a year)
   em_df2 <- lapply(seq_along(all_test2), show_EM, all_test=all_test2)
   em_df2 <- do.call(rbind, em_df2)
   em_df2$config <- 'annual'
   
   em_all <- rbind(em_df1_sep, em_df2)
   em_all$poll <- target_poll
   em_all$date <- as.Date(as.yearmon(paste0(em_all$year, '-', 01)))
   em_all
}
em_all <- lapply(c('NO2', 'O3', 'PM10', 'PM2.5'), annual_perf) %>% do.call(rbind,.)

```


```{r aggregated annual performance (5-fold CV) R2}
ggplot(em_all %>% filter(EM=='rsq') %>%  gather("model", "values", -c("EM", 'config', 'year', 'poll', 'date')) %>% filter(model=='gwr') %>% mutate(config=ifelse(config=='annual', 'annual LUR', 'monthly LUR'), config=factor(config, levels=c('annual LUR','monthly LUR'))), 
          aes(x=date, y=values, col=config))+
   geom_point()+
   geom_line()+
   facet_grid(.~poll, scales ='free')+
   theme_bw()+
   scale_x_date(#date_breaks = "3 year",
                date_labels = "%Y")+
   labs(y="R squared", col='', x='year')+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text = element_text(size = 15),
         panel.grid.minor.x=element_line(colour='grey50'),
         axis.text.x = element_text(angle=90))
ggsave('results/figures/monthly_annual_perfm.tiff', height=3, width=7.5, units='in',dpi=300)
```

heatmap of R2 and RMSE

```{r, fig.height=2, fig.width=4}
heatdf <- em_all %>% filter(EM%in%c('rsq', 'RMSE')) %>%  gather("model", "values", -c("EM", 'config', 'year', 'poll', 'date')) %>% filter(model=='gwr') %>% mutate(config=ifelse(config=='annual', 'annual LUR', 'monthly LUR'), config=factor(config, levels=c('annual LUR','monthly LUR')))
heatdf <- rbind(heatdf %>% filter(EM=='rsq') %>% mutate(EM='R2', values=round(values, 2)),
      heatdf %>% filter(EM=='RMSE') %>% mutate(values=round(values, 1)))
# pal <- wes_palette("Zissou1", 100, type = "continuous")
# ggplot(heatdf%>% filter(EM=='rsq'), aes(x=year, y=config, fill=values))+
#       geom_tile()+
#    facet_grid(EM~poll)+
#    geom_text(aes(label = values))+
#    theme_minimal()+
#    theme(axis.title = element_text(size = 13),
#          axis.text = element_text(size = 11),
#          axis.text.x = element_text(angle=90),
#          legend.title = element_text(size = 13),
#          legend.text = element_text(size = 13),
#          legend.spacing.y = unit(0.01, 'cm'),
#          strip.text = element_text(size = 12))+
#    # theme(,
#    #       )
#    theme(panel.border = element_rect(size = 0.25, linetype = 'solid', fill = 'transparent'),
#          panel.grid.major.x = element_line(size = 0.25, linetype = 'solid', colour = 'black'))

ggplot(heatdf)+
   geom_point(alpha=0.7, aes(x=date, y=values, col=config, shape=config, group=config))+
   geom_line(alpha=0.8, aes(x=date, y=values, col=config, lintype=config, group=config))+
   # facet_wrap(EM~poll, scales ='free_y')+
   facet_wrap(poll~EM, scales ='free', nrow=2, dir='v')+
   theme_bw()+
   scale_x_date(#date_breaks = "3 year",
                date_labels = "%Y")+
   labs(y="values", col='', x='year', col='', linetype='', shape='')+
   
   scale_shape_manual(values=1:2)+
      scale_linetype_manual(values=1:2)+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text = element_text(size = 15),
         panel.grid.minor.x=element_line(colour='grey50'),
         axis.text.x = element_text(angle=90))
ggsave('results/figures/monthly_annual_perfm_v2.tiff', height=5, width=12, units='in', dpi=300)

```
```{r}

```


```{r}
ggplot(em_all %>% filter(EM=='RMSE') %>%  gather("model", "values", -c("EM", 'config', 'year', 'poll', 'date')), 
          aes(x=date, y=values, col=config))+
   geom_point()+
   geom_line()+
   facet_grid(model~poll, scales ='free')+
   theme_bw()+
   scale_x_date(date_breaks = "3 year",
                date_labels = "%Y")+
   labs(y="RMSE")+
   theme(axis.title = element_text(size = 18),
         axis.text = element_text(size = 16),
         legend.title = element_text(size = 16),
         legend.text = element_text(size = 16),
         strip.text.y = element_text(size = 15),
         panel.grid.minor.x=element_line(colour='grey50'),
         axis.text.x = element_text(angle=90))
```


```{r aggregated annual performance (5-fold CV)}
```



```{r aggregated annual no2}
do.call(grid.arrange, annual_perf('NO2'))
```


```{r aggregated annual o3}
do.call(grid.arrange, annual_perf('O3'))
```


```{r aggregated annual pm10}
do.call(grid.arrange, annual_perf('PM10'))
```



```{r aggregated annual pm25}
do.call(grid.arrange, annual_perf('PM2.5'))

```


## 5-fold accuracy of annual (aggregated) predictions separated by climate zones
MSE-R2 was used:


```{r monthly performance (5-fold CV), eval=T, echo=F, fig.height=8.2, fig.width=7.5}
annual_perfm_region <- function(target_poll){
   all_test2_yr <- read_perfm2(target_poll)

   
   df_all <- inner_join(df_all,
                        read.csv('../EXPANSE_predictor/data/processed/climate_code.csv'),
                        by='zoneID')
   df_all <- df_all[!duplicated(df_all$sta_code),]
   
   # Monthly models (built for each month)
   all_test_sep <- read_perfm(target_poll)
   all_test_sep2 <- lapply(all_test_sep, function(sep_df){
      inner_join(sep_df, df_all, by=c('sta_code'))%>% 
         filter(sta_code%in%(names(table(all_test_sep2$sta_code)[table(all_test_sep2$sta_code)>=9]))) %>% 
         group_by(sta_code, year, climate_zone) %>% 
         summarise(rf=mean(rf), slr=mean(slr), gwr=mean(gwr), .groups = 'drop') %>% 
         inner_join(., all_test2_yr[[1]][, c('obs','sta_code')], by='sta_code')
   }) %>% do.call(rbind, .)
      
   em_df1_sep <- lapply(unique(all_test_sep2$climate_zone), function(id){
      target_df <- all_test_sep2 %>% filter(climate_zone==id)
      lapply(unique(target_df$year), function(target_yr){
         show_EM(list(target_df %>% filter(year==target_yr)), 1, region=T)
      }) %>% do.call(rbind,.)
   }) 
   
   em_df1_sep <- do.call(rbind, em_df1_sep)
   em_df1_sep$config <- '1-month'
   
   
   # Annual models (bult for a year)
   all_test2_yr <- lapply(all_test2_yr, function(yr_df){
      inner_join(yr_df, df_all, by='sta_code') %>% 
         filter(sta_code%in%unique(all_test_sep2$sta_code))
   })
   all_test2_yr <- do.call(rbind, all_test2_yr)
   
   em_df2 <- lapply(unique(all_test2_yr$climate_zone), function(id){
      target_df <- all_test2_yr %>% filter(climate_zone==id)
      lapply(unique(target_df$year), function(target_yr){
         show_EM(list(target_df %>% filter(year==target_yr)), 1, region=T)
      }) %>% do.call(rbind,.)
   }) 
      
   em_df2 <- do.call(rbind, em_df2)
   em_df2$config <- 'annual'
   
   
   em_df <- rbind(em_df1_sep, em_df2)
   em_df2 <- em_df
   em_df$climate_zone <- unlist(lapply(strsplit(em_df$climate_zone, '_'), '[[', 1))
   em_df$count <- unlist(lapply(strsplit(em_df2$climate_zone, '_'), '[[', 2))
   heat_df <- em_df %>% filter(EM=='explained_var') %>%  gather("model", "values", -c("EM", 'config', 'climate_zone', 'count','year'))
   heat_df$name <- paste0(heat_df$model, '-', 
                          unlist(lapply(strsplit(heat_df$config, '-'), `[[`, 1)))
    pal <- wes_palette("Zissou1", 100, type = "continuous")
   # Heatmap
   p1 <- ggplot(heat_df, aes(x=year, y=values, col=model))+
      # geom_tile()+
      geom_point()+
      facet_grid(climate_zone~config)+
      labs(x='', y='', fill='R2', title=target_poll)+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 13),
            axis.text.x = element_text(angle = 90),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      scale_fill_gradientn(colours = pal)
   # barplot
   p2 <- ggplot(em_df %>% filter(EM=='explained_var') %>%  gather("model", "values", -c("EM", 'config', 'climate_zone')),
          aes(x=model, y=values, fill=config))+
      geom_bar(stat="identity", position = "dodge2")+
      facet_grid(.~climate_zone, scales ='free')+
      labs(title=target_poll)+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))
   print(grid.arrange(p1, p2, nrow=2, ncol=1))
}
```

* For NO2, the differences in R2 between models for different regions are small. 

```{r, eval=T, echo=F, fig.height=8.2, fig.width=7.5}
annual_perfm_region('NO2')
```


* For O3, PM10, PM2.5, the differences in R2 between models for different regions are large. For O3, the 1-month SLR even outperforms the annual model for estimating the annual average concentrations 


```{r, eval=T, echo=F, fig.height=8.2, fig.width=7.5}
annual_perfm_region('O3')
```


```{r, eval=T, echo=F, fig.height=8.2, fig.width=7.5}
annual_perfm_region('PM10')
```


```{r, eval=T, echo=F, fig.height=8.2, fig.width=7.5}
annual_perfm_region('PM2.5')


# ggplot(all_test2_yr[[1]] %>% filter(climate_zone=='Northern'))+
#     geom_point(aes(x=rf, y=obs))+
#     geom_point(data=(all_test2_yr[[1]] %>% filter(climate_zone=='Northern', sta_code=='NO0088A')), aes(x=rf, y=obs), col='red')
# ggplot(all_test_sep3 %>% filter(climate_zone=='Northern'))+
#     geom_point(aes(x=rf, y=obs))+
#     geom_point(data=(all_test_sep3 %>% filter(climate_zone=='Northern', sta_code=='NO0088A')), aes(x=rf, y=obs), col='red')


```


## 5-fold CV accuracy of monthly predictions separated by months and climate zones
```{r}
monthly_perfm_region_month <- function(target_poll){
   # Monthly models (built for all 12 months)
   all_test <- read_perfm(target_poll)
   if(target_poll=='PM2.5'){
      df_all <- read.csv(paste0('data/raw/gee/pred_PM25_2010_monthly.csv')) %>% dplyr::select(zoneID, sta_code)
   }else{
      df_all <- read.csv(paste0('data/raw/gee/pred_', target_poll, '_2010_monthly.csv')) %>% dplyr::select(zoneID, sta_code)
   }
   df_all <- inner_join(df_all,
                        read.csv('../EXPANSE_predictor/data/processed/climate_code.csv'),
                        by='zoneID')
   df_all <- df_all[!duplicated(df_all$sta_code),]
   all_test2 <- inner_join(all_test[[1]], df_all, by=c('sta_code'))
   id_df <- expand.grid(month=unique(all_test2$month), climate_zone=unique(all_test2$climate_zone))
   all_test3 <- lapply(1:nrow(id_df), function(i){
      id=id_df[i, 'month']
      climate_id=id_df[i, 'climate_zone']
         all_test2 %>% filter(month==id, climate_zone==climate_id)
   })
   
   em_df1 <- lapply(seq_along(all_test3), show_EM, all_test=all_test3, region=T, month=T)
   em_df1 <- do.call(rbind, em_df1)
   em_df1$config <- '12-month'

   # Monthly models (built for each month)
   all_test_sep <- read_perfm(target_poll, T)
   all_test_sep2 <- inner_join(all_test_sep[[1]], df_all, by=c('sta_code'))
   all_test_sep3 <- lapply(1:nrow(id_df), function(i){
      id=id_df[i, 'month']
      climate_id=id_df[i, 'climate_zone']
         all_test_sep2 %>% filter(month==id, climate_zone==climate_id)
   })


   em_df1_sep <- lapply(seq_along(all_test_sep3), show_EM, all_test=all_test_sep3, region=T, month=T)
   em_df1_sep <- do.call(rbind, em_df1_sep)
   em_df1_sep$config <- '1-month'


   em_df <- rbind(em_df1, em_df1_sep)
   heat_df <- em_df %>% 
    filter(EM=='explained_var') %>% 
    gather("model", "values", -c("EM", 'config', 'month', 'climate_zone')) %>% 
    mutate(month=factor(month, levels = unique(em_df$month)))
   heat_df$name <- paste0(heat_df$model,'-', unlist(lapply(strsplit(heat_df$config, '-'), `[[`, 1)))
   
   pal <- wes_palette("Zissou1", 100, type = "continuous")
   # Heatmap
   p1 <- ggplot(heat_df, aes(x=month, y=name, fill=values))+
      geom_tile()+
      labs(x='month', y='', fill='R2', title=target_poll)+
      facet_wrap(climate_zone~., scales='free_x')+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 13),
            axis.text.x = element_text(angle = 90),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      scale_fill_gradientn(colours = pal)
      # scale_fill_brewer(palette = 'Oranges')
      # 
   # barplot
   em_df2 <- em_df
   em_df2$month <- unlist(lapply(strsplit(em_df2$month, '_'), `[[`, 1))
   p2 <- ggplot(em_df2 %>%
                   filter(EM=='explained_var') %>%
                   gather("model", "values", -c("EM", 'config', 'month','climate_zone')) %>%
                   mutate(month=factor(month, levels = unique(em_df2$month))),
          aes(x=model, y=values, fill=config))+
      geom_bar(stat="identity", position = "dodge2")+
      facet_grid(climate_zone~month, scales ='free')+
      labs(title=target_poll)+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))

   grid.arrange(p1, p2)
}
```


* For NO2, in some months, the 12-month SLR cannot captures the spatial variation as well as the 1-month SLR. (May-Aug in Northern; Dec-Feb in Alpine)


```{r, fig.height=10, fig.width=7}
monthly_perfm_region_month('NO2')
```


* For O3, PM10, and PM2.5, in specific months, the 12-month SLR model performs way worst than the 1-month SLR model. 

```{r, fig.height=10, fig.width=7.9}
monthly_perfm_region_month('O3')
```
```{r, fig.height=10, fig.width=7.9}
monthly_perfm_region_month('PM10')
```
```{r, fig.height=10, fig.width=7.9}
monthly_perfm_region_month('PM2.5')
```



## Predictors selected in SLR

```{r, fig.width=8, fig.height=10}
create_heatmap_monthly('NO2')
create_heatmap_monthly('O3')
create_heatmap_monthly('PM10')
create_heatmap_monthly('PM2.5')
```

# Seasonality

## Visualization
```{r}
vis <- function(target_poll, no_sta){
   no2 <- read.csv(paste0('data/workingData/5cv_monthly_2010_', target_poll, '.csv'))
   no2 <- no2 %>% mutate(date=as.Date(make_datetime(year, month)),
                         cntr=substr(sta_code, 1, 2))
   
   no2_sep <- read.csv(paste0('data/workingData/5cv_monthly_2010_sep_', target_poll, '.csv'))
   no2_sep <- no2_sep %>% mutate(date=as.Date(make_datetime(year, month)),
                         cntr=substr(sta_code, 1, 2))
   
   p1 <- ggplot(no2 %>% filter(sta_code%in%unique(no2$sta_code)[1:no_sta]) %>% 
             gather('model', 'values', 
                    c('slr','rf','obs')), 
          aes(date, values, group=interaction(model, sta_code), col=model))+
      geom_line()+
      labs(title=paste0(target_poll, ' (12-month)'))+
      theme(axis.text.x = element_text(angle = 90))+
      facet_wrap(sta_code~., scales='fixed')
   p_sep <- ggplot(no2_sep %>% filter(sta_code%in%unique(no2$sta_code)[1:no_sta]) %>% 
             gather('model', 'values', 
                    c('slr','rf','obs')), 
          aes(date, values, group=interaction(model, sta_code), col=model))+
      geom_line()+
      labs(title=paste0(target_poll, ' (1-month)'))+
      theme(axis.text.x = element_text(angle = 90))+
      facet_wrap(sta_code~., scales='fixed')
   print(p1)
   print(p_sep)
}

vis('NO2', 20)
vis('O3', 20)
vis('PM2.5', 20)

```


```{r}
## Correlations of residuals
plot_cor <- function(target_poll, all_df, var_c, var_title){

   no2_wide2 <- dcast(all_df[, c(var_c, 'month', 'sta_code')],
                      as.formula(paste0('sta_code~', 'month')), 
                      value.var = var_c)
   
   
   lowerFn <- function(data, mapping, ...) {
      p <- ggplot(data = data, mapping = mapping) +
         geom_point(colour = "black") +
         geom_abline(intercept=0, slope=1, col='red')+
         lims(x=c(min(data), max(data)),y=c(min(data), max(data)))
      p
   }
   png(file = paste0("results/figures/corr_obs", 'corr_', target_poll, "_2010_", 
                     var_title, '.png'), 
       res = 150, width = 1500, height = 1300)
   print(ggpairs(data=no2_wide2[,-c(1)], lower = list(continuous = wrap(lowerFn)),
                 title = var_c,
                 diag=list(discrete="barDiag", 
                           continuous = wrap("densityDiag", alpha=0.5))))
   dev.off()
   return(0)
}
all_cor <- function(target_poll){
   all_m <- ( read_perfm(target_poll)[[1]])
   all_m_sep <- (read_perfm(target_poll, T)[[1]])
   plot_cor(target_poll, all_m_sep %>% mutate(res=rf-obs), 'res', '1-month rf res')
   plot_cor(target_poll, all_m_sep %>% mutate(res=slr-obs), 'res', '1-month slr res')
}
all_cor('NO2')

```


## AR analysis
Use stations that are active throughout a certain period of time.

Correlation only compare values between two different variables, whereas autocorrelation gives the correlations between the same variables from two different time points with a k lag. 

The autocorrelation (Box and Jenkins, 1976) function can be used for the following two purposes ([source](https://www.itl.nist.gov/div898/handbook/eda/section3/eda35c.htm)):
1. To detect non-randomness in data.
2. To identify an appropriate time series model if the data are not random.

The autocorrelation values can also give the following information:
1. Trends
2. Seasonal patterns


```{r}
monthly <- fread('../EXPANSE_APM//data/processed/all_m_conc4xy_cleaned.csv')
```



```{r}
## Overall ACF (All stations together, all pollutan)
# test_acf <- acf((monthly%>%filter(sta_code%in%names(monthly_tbl[monthly_tbl==max(monthly_tbl)])))$obs)
```

```{r}
calc_acf <- function(dat, varname, time_step){
   out_dat <- acf(dat[, varname], plot=F, lag.max=(time_step-1)*12)$acf[-1]
   out_dat <- as.data.frame(t(out_dat))
   names(out_dat) <- paste0('ar_', 1:length(out_dat))
   out_dat
}
acf_timeseries <- function(dat, tperiod, target_poll){
   dat <- dat %>% filter(component_caption==target_poll,
                                 year%in%(tperiod)) %>% 
      arrange(year, month)
   dat_tbl <- table(dat$sta_code)
   acf_dat <- dat%>%
      filter(sta_code%in%names(dat_tbl[dat_tbl==max(dat_tbl)])) %>% 
      group_by(sta_code) %>%
      do(calc_acf(., 'obs', length(tperiod)))
   
   acf_avg <- acf_dat[-1] %>% apply(., 2, mean)
   acf_sd <- acf_dat[-1] %>% apply(., 2, sd)
   # summarise(
   #    acf1=acf(obs, plot = F)$acf[-1][1],
   #    acf12=acf(obs, plot = F)$acf[-1][12],
   #    acf24=acf(obs, plot = F)$acf[-1][24]
   # )
   ggplot(acf_dat %>% gather('ar', 'values', -'sta_code') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))))+
      geom_line(aes(x=reorder(lag, lag), y=values, group=sta_code), alpha=0.25)+
      geom_line(data=acf_avg %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='red', lwd=1)+
      geom_text(data=acf_avg %>% 
                   t()%>% as.data.frame()%>% 
                   gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))) %>% 
                   filter(lag%in% c(1, seq(12, (12*length(tperiod)-1), 12))),
                aes(label=round(values, 1), x=lag+0.2, y=0.75), col='red')+
      
      geom_line(data=(acf_avg+acf_sd) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      geom_line(data=(acf_avg-acf_sd) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      
      geom_vline(xintercept = seq(12, (12*length(tperiod)-1), 12),
                 lty=2)+
      labs(title=paste0(target_poll, ': ', min(tperiod), '-', max(tperiod)),
           subtitle=paste0('no. of stations=', nrow(acf_dat)),
           x='lag (months)', y='autocorrelation')+
      scale_x_discrete(breaks = c(1, seq(6, (12*length(tperiod)-1), 6)))
   # geom_abline(intercept = 0, slope=1)
}


vis_ar <- function(target_poll, target_str){
   no2 <- read.csv(paste0('data/workingData/5cv_monthly_2010_', target_poll, '.csv'))
   no2 <- no2 %>% mutate(date=as.Date(make_datetime(year, month)),
                         cntr=substr(sta_code, 1, 2))
   
   no2_sep <- read.csv(paste0('data/workingData/5cv_monthly_2010_sep_', target_poll, '.csv'))
   no2_sep <- no2_sep %>% mutate(date=as.Date(make_datetime(year, month)),
                         cntr=substr(sta_code, 1, 2))
   
   dat <- no2 %>% arrange(sta_code, year, month)
   dat_tbl <- table(dat$sta_code)
   acf_dat <- dat%>%
      filter(sta_code%in%names(dat_tbl[dat_tbl==max(dat_tbl)])) %>% 
      group_by(sta_code) %>%
      do(calc_acf(., target_str, max(dat_tbl)))
   acf_avg <- acf_dat[-1] %>% apply(., 2, mean)
   acf_sd <- acf_dat[-1] %>% apply(., 2, sd)
   
   dat_sep <- no2_sep %>% arrange(sta_code, year, month)
   dat_tbl_sep <- table(dat_sep$sta_code)
   acf_dat_sep <- dat_sep %>%
      filter(sta_code%in%names(dat_tbl_sep[dat_tbl_sep==max(dat_tbl_sep)])) %>% group_by(sta_code) %>%
      do(calc_acf(., target_str, max(dat_tbl_sep)))
   acf_avg_sep <- acf_dat_sep[-1] %>% apply(., 2, mean)
   acf_sd_sep <- acf_dat_sep[-1] %>% apply(., 2, sd)
   
   
   
   acf_dat_obs <- dat_sep %>%
      filter(sta_code%in%names(dat_tbl_sep[dat_tbl_sep==max(dat_tbl_sep)])) %>% group_by(sta_code) %>%
      do(calc_acf(., 'obs', max(dat_tbl_sep)))
   acf_avg_obs <- acf_dat_obs[-1] %>% apply(., 2, mean)
   acf_sd_obs <- acf_dat_obs[-1] %>% apply(., 2, sd)
   
   
   
   p1 <- ggplot(acf_dat %>% gather('ar', 'values', -'sta_code') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))))+
      geom_line(aes(x=reorder(lag, lag), y=values, group=sta_code), alpha=0.25)+
      geom_line(data=acf_avg %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='red', lwd=1)+
      geom_text(data=acf_avg %>% 
                   t()%>% as.data.frame()%>% 
                   gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))) %>% 
                   filter(lag%in% c(1, seq(2, 12, 2))),
                aes(label=round(values, 1), x=lag+0.2, y=0.75), col='red')+
      geom_line(data=(acf_avg+acf_sd) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      geom_line(data=(acf_avg-acf_sd) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      
      geom_vline(xintercept = seq(2, 12, 2),
                 lty=2)+
      labs(title=paste0(target_poll, ' (2010): ', target_str, ' (12-month)'),
           subtitle=paste0('no. of stations=', nrow(acf_dat)),
           x='lag (months)', y='autocorrelation')+
      scale_x_discrete(breaks = c(1, seq(2, 12, 2)))
   
   
   p_sep <- 
   ggplot(acf_dat_sep %>% gather('ar', 'values', -'sta_code') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))))+
      geom_line(aes(x=reorder(lag, lag), y=values, group=sta_code), alpha=0.25)+
      geom_line(data=acf_avg_sep %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='red', lwd=1)+
      geom_text(data=acf_avg_sep %>% 
                   t()%>% as.data.frame()%>% 
                   gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))) %>% 
                   filter(lag%in% c(1, seq(2, 12, 2))),
                aes(label=round(values, 1), x=lag+0.2, y=0.75), col='red')+
      geom_line(data=(acf_avg_sep+acf_sd_sep) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      geom_line(data=(acf_avg_sep-acf_sd_sep) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      
      geom_vline(xintercept = seq(2, 12, 2),
                 lty=2)+
      labs(title=paste0(target_poll, ' (2010): ', target_str, ' (1-month)'),
           subtitle=paste0('no. of stations=', nrow(acf_dat_sep)),
           x='lag (months)', y='autocorrelation')+
      scale_x_discrete(breaks = c(1, seq(2, 12, 2)))
   
    p_obs <- 
   ggplot(acf_dat_obs %>% gather('ar', 'values', -'sta_code') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))))+
      geom_line(aes(x=reorder(lag, lag), y=values, group=sta_code), alpha=0.25)+
      geom_line(data=acf_avg_obs %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='red', lwd=1)+
      geom_text(data=acf_avg_obs %>% 
                   t()%>% as.data.frame()%>% 
                   gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))) %>% 
                   filter(lag%in% c(1, seq(2, 12, 2))),
                aes(label=round(values, 1), x=lag+0.2, y=0.75), col='red')+
         geom_line(data=(acf_avg_obs+acf_sd_obs) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
       geom_line(data=(acf_avg_obs-acf_sd_obs) %>% t()%>% as.data.frame()%>% gather('ar', 'values') %>% mutate(lag=as.numeric(gsub('ar_', '', ar))), 
                aes(x=reorder(lag, lag), y=values, group=1), col='grey', lwd=0.7, lty=3)+
      
       
      geom_vline(xintercept = seq(2, 12, 2),
                 lty=2)+
      labs(title=paste0(target_poll, ' (2010): ',  'obs'),
           subtitle=paste0('no. of stations=', nrow(acf_dat_sep)),
           x='lag (months)', y='autocorrelation')+
      scale_x_discrete(breaks = c(1, seq(2, 12, 2)))
   
   print(grid.arrange(p1, p_sep, p_obs))
}
```

```{r, fig.height=6, fig.width=5}
vis_ar('NO2', 'slr')
vis_ar('NO2', 'rf')
```

```{r, fig.height=6, fig.width=5}
vis_ar('O3', 'slr')
vis_ar('O3', 'rf')
```

```{r, fig.height=6, fig.width=5}
vis_ar('PM2.5', 'slr')
vis_ar('PM2.5', 'rf')
```

# Observations

```{r, fig.height=10, fig.width=12}

do.call(grid.arrange, list(acf_timeseries(monthly, 2015:2019,'NO2'),
                           acf_timeseries(monthly, 2010:2019,'NO2'),
                           acf_timeseries(monthly, 2000:2019,'NO2')))
```




```{r, fig.height=10, fig.width=12}
do.call(grid.arrange, list(acf_timeseries(monthly, 2015:2019,'O3'),
                           acf_timeseries(monthly, 2010:2019,'O3'),
                           acf_timeseries(monthly, 2000:2019,'O3')))
```

```{r, fig.height=10, fig.width=12}

do.call(grid.arrange, list(acf_timeseries(monthly, 2015:2019,'PM10'),
                           acf_timeseries(monthly, 2010:2019,'PM10'),
                           acf_timeseries(monthly, 2000:2019,'PM10')))
```

```{r, fig.height=10, fig.width=12}

do.call(grid.arrange, list(acf_timeseries(monthly, 2015:2019,'PM2.5'),
                           acf_timeseries(monthly, 2010:2019,'PM2.5'),
                           acf_timeseries(monthly, 2000:2019,'PM2.5')))
```




```{r}
# monthly <- monthly %>% mutate(date=as.Date(make_datetime(year, month)),
#                          cntr=substr(sta_code, 1, 2))
#    
# ggplot(monthly %>% filter(sta_code=='IT0871A'), 
#        aes(date, obs, group=sta_code))+
#    geom_line()+
#    theme(axis.text.x = element_text(angle = 90))+
#    facet_wrap(sta_code~., scales='free_y')
 
```

```{r}
# plot.acf <- function(ACFobj) {
#    rr <- ACFobj$acf[-1]
#    kk <- length(rr)
#    nn <- ACFobj$n.used
#    plot(seq(kk), rr, type = "h", lwd = 2, yaxs = "i", xaxs = "i", 
#         ylim = c(floor(min(rr)), 1), xlim = c(0, kk + 1), xlab = "Lag", 
#         ylab = "Correlation", las = 1)
#    abline(h = -1/nn + c(-2, 2)/sqrt(nn), lty = "dashed", col = "blue")
#    abline(h = 0)
# }
# all_m <- ( read_perfm(target_poll)[[1]])
# all_m_sep <- (read_perfm(target_poll, T)[[1]])
# m_acf1 <- all_m %>%
#    group_by(sta_code) %>%
#    summarise(
#       obs=acf(obs, plot = F)$acf[-1][1],
#       slr=acf(slr, plot = F)$acf[-1][1],
#       rf=acf(rf, plot = F)$acf[-1][1]
#    )
# 
# ggplot(m_acf1, aes(x=obs, y=slr))+
#    geom_point()+
#    geom_abline(intercept = 0, slope=1)
# all_m <- all_m %>% mutate(date=as.Date(make_datetime(year, month)),
#                          cntr=substr(sta_code, 1, 2))
#    
#    p1 <- ggplot(all_m %>% filter(sta_code=='ES1689A') %>% 
#              gather('model', 'values', 
#                     c('slr','rf','obs')), 
#           aes(date, values, group=interaction(model, sta_code), col=model))+
#       geom_line()+
#       # labs(title=paste0(target_poll, ' (12-month)'))+
#       theme(axis.text.x = element_text(angle = 90))+
#       facet_wrap(sta_code~., scales='free_y')

```



### Archive
5-fold accuracy of monthly predictions separated by months

```{r}
## 5-fold accuracy of monthly predictions separated by months
# MSE-R2 was used:
monthly_perfm_region <- function(target_poll){
   # Monthly models (built for all 12 months)
   all_test <- read_perfm(target_poll)
   if(target_poll=='PM2.5'){
      df_all <- read.csv(paste0('data/raw/gee/pred_PM25_2010_monthly.csv')) %>% dplyr::select(zoneID, sta_code)
   }else{
      df_all <- read.csv(paste0('data/raw/gee/pred_', target_poll, '_2010_monthly.csv')) %>% dplyr::select(zoneID, sta_code)
   }
   df_all <- inner_join(df_all,
                        read.csv('../EXPANSE_predictor/data/processed/climate_code.csv'),
                        by='zoneID')
   df_all <- df_all[!duplicated(df_all$sta_code),]
   all_test2 <- inner_join(all_test[[1]], df_all, by=c('sta_code'))
   all_test3 <- lapply(unique(all_test2$month), function(id){
      all_test2 %>% filter(month==id)
   })
   
   em_df1 <- lapply(seq_along(all_test3), show_EM, all_test=all_test3, region=F, month=T)
   em_df1 <- do.call(rbind, em_df1)
   em_df1$config <- '12-month'

   # Monthly models (built for each month)
   all_test_sep <- read_perfm(target_poll, T)
   all_test_sep2 <- inner_join(all_test_sep[[1]], df_all, by=c('sta_code'))
   all_test_sep3 <- lapply(unique(all_test_sep2$month), function(id){
      all_test_sep2 %>% filter(month==id)
   })


   em_df1_sep <- lapply(seq_along(all_test_sep3), show_EM, all_test=all_test_sep3, region=F, month=T)
   em_df1_sep <- do.call(rbind, em_df1_sep)
   em_df1_sep$config <- '1-month'


   em_df <- rbind(em_df1, em_df1_sep)
   heat_df <- em_df %>% 
    filter(EM=='explained_var') %>% 
    gather("model", "values", -c("EM", 'config', 'month')) %>% 
    mutate(month=factor(month, levels = unique(em_df$month)))
   heat_df$name <- paste0(heat_df$model,'-', unlist(lapply(strsplit(heat_df$config, '-'), `[[`, 1)))
   
   pal <- wes_palette("Zissou1", 100, type = "continuous")
   # Heatmap
   p1 <- ggplot(heat_df, aes(x=month, y=name, fill=values))+
      geom_tile()+
      labs(x='month', y='', fill='R2', title=target_poll)+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 13),
            axis.text.x = element_text(angle = 90),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))+
      scale_fill_gradientn(colours = pal)
      # scale_fill_brewer(palette = 'Oranges')
      # 
   # barplot
   p2 <- ggplot(em_df %>%
                   filter(EM=='explained_var') %>%
                   gather("model", "values", -c("EM", 'config', 'month')) %>%
                   mutate(month=factor(month, levels = unique(em_df$month))),
          aes(x=model, y=values, fill=config))+
      geom_bar(stat="identity", position = "dodge2")+
      facet_grid(.~month, scales ='free')+
      labs(title=target_poll)+
      labs(y="R squared")+
      theme(axis.title = element_text(size = 18),
            axis.text = element_text(size = 16),
            legend.title = element_text(size = 16),
            legend.text = element_text(size = 16),
            strip.text.y = element_text(size = 15))

   grid.arrange(p1, p2)
}
```


* For NO2, in some months, the 12-month SLR cannot captures the spatial variation as well as the 1-month SLR. (May-Aug; Dec-Feb)

```{r, fig.height=6.6, fig.width=7.5}
monthly_perfm_region('NO2')
```

* For all pollutants, in specific months, the 12-month SLR model performs way worst than the 1-month SLR model. (especially in summer)

```{r, fig.height=6.6, fig.width=7.5}
monthly_perfm_region('O3')
```


```{r, fig.height=6.6, fig.width=7.5}
monthly_perfm_region('PM10')
```


```{r, fig.height=6.6, fig.width=7.5}
monthly_perfm_region('PM2.5')
```

